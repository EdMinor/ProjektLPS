<!-- Header -->
<app-header [breadcrumbs]="breadcrumbs"></app-header>

<!-- Main Content -->
<div class="question-container">
  <!-- Question Block Container -->
  <div class="question-block">
    <!-- Block Header with Progress -->
    <div class="block-header">
      <div class="header-content">
        <div class="header-left">
          <h1>{{ catalog?.title || 'Katalog' }}</h1>
          <p class="catalog-code">{{ catalog?.code || '' }}</p>
        </div>
        
        <div class="header-right">
          <div class="progress-info">
            <span class="question-counter">Frage {{ questionNumber }} von {{ totalQuestions }}</span>
            <span class="progress-text">Fortschritt: {{ answeredQuestions.size }} / {{ questions.length }}</span>
          </div>
        </div>
      </div>
      
      <!-- Progress Bar Background -->
      <div class="progress-background">
        <div class="progress-fill" [style.width.%]="(answeredQuestions.size / questions.length) * 100"></div>
      </div>
      
      <!-- Question Navigation Dots in Header -->
      <div class="question-navigation">
        <div 
          *ngFor="let question of questions; let i = index"
          class="nav-dot"
          [class.current]="i === currentIndex"
          [class.answered]="answeredQuestions.has(i)"
          [class.correct]="answeredQuestions.has(i) && answeredQuestions.get(i)?.isCorrect"
          [class.incorrect]="answeredQuestions.has(i) && !answeredQuestions.get(i)?.isCorrect"
          (click)="goToQuestion(i)"
        ></div>
      </div>
    </div>

    <!-- Block Content -->
    <div class="block-content">
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="loading-spinner"></div>
        <p>Frage wird geladen...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error" class="error-state">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p>{{ error }}</p>
        <button class="btn btn-outline" (click)="loadCatalogAndQuestions()">
          Erneut versuchen
        </button>
      </div>

      <!-- Question Content -->
      <div *ngIf="!loading && !error && question" class="question-content">
        <!-- Question Type Badge -->
        <div class="question-type-badge">
          {{ question.type === 'single' ? 'Single Choice' : 
             question.type === 'multi' ? 'Multiple Choice' : 'Fill-in' }}
        </div>

        <!-- Question Text -->
        <div class="question-text">
          <h2>{{ question.text }}</h2>
        </div>

        <!-- Answer Options -->
        <div class="answer-options" *ngIf="question.type === 'single' || question.type === 'multi'">
          <div 
            *ngFor="let option of question.options; let optionIndex = index"
            class="option-item"
            [class.selected]="isOptionSelected(option.id)"
            [class.correct]="showSolution && isOptionCorrect(option.id)"
            [class.incorrect]="showSolution && isOptionSelected(option.id) && !isOptionCorrect(option.id)"
            [class.disabled]="showSolution"
            (click)="selectOption(option.id)"
          >
            <div class="option-input">
              <input 
                [type]="question.type === 'single' ? 'radio' : 'checkbox'"
                [name]="'question-' + question.id"
                [value]="option.id"
                [checked]="isOptionSelected(option.id)"
                [disabled]="showSolution"
                (change)="selectOption(option.id)"
              >
            </div>
            <div class="option-text">
              <span class="option-label">{{ getOptionLabel(optionIndex) }}</span>
              <span class="option-content">{{ option.text }}</span>
            </div>
          </div>
        </div>

        <!-- Fill-in Answer -->
        <div class="fill-in-answer" *ngIf="question.type === 'fill'">
          <label for="fillInInput">Deine Antwort:</label>
          <input 
            id="fillInInput"
            type="text" 
            [(ngModel)]="fillInAnswer"
            placeholder="Antwort eingeben..."
            [disabled]="showSolution"
            class="fill-in-input"
            (input)="onFillInInput($event)"
          >
          <button 
            *ngIf="!showSolution && hasAnswered"
            class="btn btn-primary fill-in-confirm"
            (click)="confirmFillInAnswer()"
          >
            Antwort best√§tigen
          </button>
        </div>

        <!-- Solution Display -->
        <div *ngIf="showSolution" class="solution-display" [class.correct-answer]="isCurrentQuestionCorrect()" [class.incorrect-answer]="!isCurrentQuestionCorrect()">
          <div class="solution-header">
            <h3>L√∂sung</h3>
          </div>
          
          <div class="solution-content">
            <p><strong>Korrekte Antwort:</strong></p>
            <div class="correct-answers">
              <span *ngFor="let answer of getCorrectAnswers()" class="correct-answer">
                {{ answer }}
              </span>
            </div>
            
            <div *ngIf="question.explanation" class="explanation">
              <p><strong>Erkl√§rung:</strong></p>
              <p>{{ question.explanation }}</p>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button 
            *ngIf="!showSolution && question.type === 'multi'"
            class="btn btn-primary"
            (click)="checkAnswer()"
            [disabled]="!canCheckAnswer()"
          >
            L√∂sung anzeigen
          </button>

          <button 
            *ngIf="showSolution && canGoPrevious"
            class="btn btn-outline"
            (click)="goToPrevious()"
          >
            ‚Üê Zur√ºck
          </button>

          <button 
            *ngIf="showSolution && canGoNext"
            class="btn btn-primary"
            (click)="goToNext()"
            [disabled]="!canGoNext"
          >
            Weiter ‚Üí
          </button>

          <button 
            *ngIf="isCatalogCompleted() && !showResultsPopup"
            class="btn btn-primary"
            (click)="showResultsPopup = true"
          >
            üìä Ergebnisse anzeigen
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results Popup -->
<div *ngIf="showResultsPopup" class="results-popup-overlay" (click)="showResultsPopup = false">
  <div class="results-popup" (click)="$event.stopPropagation()">
    <div class="score-circle" [class]="getPerformanceClass()">
      {{ Math.round((score / questions.length) * 100) }}%
    </div>
    
    <h2>Katalog abgeschlossen!</h2>
    <p>
      Du hast {{ score }} von {{ questions.length }} Fragen richtig beantwortet.
      {{ getPerformanceText() }}
    </p>
    
    <div class="results-button-container">
      <button class="btn btn-outline results-button" (click)="showResultsPopup = false">
        Schlie√üen
      </button>
      <button class="btn btn-primary results-button" (click)="goToHome()">
        üè† Zur√ºck zum Start
      </button>
    </div>
  </div>
</div>
